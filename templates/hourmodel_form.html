{% load static %}

<html>
<head>
    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>

    <script src="{% static 'hour_manager/js/picker.js' %}"></script>
    <script src="{% static 'hour_manager/js/picker.date.js' %}"></script>
    <script src="{% static 'hour_manager/js/picker.time.js' %}"></script>
    
    <link rel="stylesheet" href="{% static 'hour_manager/css/default.css' %}">
    <link rel="stylesheet" href="{% static 'hour_manager/css/default.time.css' %}">
    <link rel="stylesheet" href="{% static 'hour_manager/css/default.date.css' %}">

    <link rel="stylesheet" type="text/css" href="{% static 'hour_manager/css/menu.css' %}">
    <link rel="stylesheet" href="{% static 'hour_manager/css/add_hour.css' %}">

    <script>
        //So django will accept the delete request
        function fillFields() {
          $("#id_date").prop('disabled', true)
          $("#id_start_time").prop('disabled', true)
          $("#id_end_time").prop('disabled', true)
          $("#id_reason").prop('disabled', true)
        }

        // Initially the 3 global variables we want are our 3 different type of forms. These will be accessed many times
        var dateInput
        var startTimeInput
        var endTimeInput;
        
        // In military time, this represents the starting and ending time of variable days. 
        weekdayStartTime = 8
        weekdayEndTime = 21
        
        saturdayStartTime = 11
        saturdayEndTime = 18
        
        sundayStartTime = 14
        // I have this comment here to show I didnt forget about sunday end time, it just happens to be the same as a normal week day
        // sundayEndTime = 21
        
        $(function() {
            // Define our dateInput (calandar)
            dateInput = $('#id_date').pickadate({
              onClose: function() {   
                // On close we want to peform a quick check on our start time and end time forms to see if they are still within bounds.
                checkInputBounds(startTimeInput, false)
                checkInputBounds(endTimeInput, true)
              },
              
              // Formatting for how we present the data and how the backend receives the data
              format: 'dddd, mmmm dd, yyyy',
              formatSubmit: 'yyyy/mm/dd',
              formatSubmit: 'yyyy-mm-dd',
              hiddenSuffix: ''
            })
            
            // Define our startTimeInput (Start of shift)
            startTimeInput = $('#id_start_time').pickatime({
              onOpen: function() {
                // Upon opening, we peform a check to see what our min and max should be due to the date.
                // It'll be more clear in endTimeInput on why we do this upon opening of the form
                limitHoursToDay(startTimeInput, false)
              },
              
              onClose: function() {
                startData = getSelectData(startTimeInput)
                endData = getSelectData(endTimeInput)
                
                // Assuming that the start time was set, we do a quick quick against our end time. 
                // If end time is set and bigger or equal to our new start time, we wipe it
                if ((startData != null && endData != null) && (endData.hour <= startData.hour)) {
                  getPicker(endTimeInput).clear()
                }
              },
              
              // Shifts are listed every hour, aka 60 minutes
              interval: 60,
              formatSubmit: 'HH:i',
              hiddenSuffix: ''
            })
            
            // Define our endTimeInput (End of shift)
            endTimeInput = $('#id_end_time').pickatime({
              
              onOpen: function() {
                // We limit our end time lowerbound to our start time value
                // So we start off by checking if our startTimeInput was even set yet...
                if (getSelectData(startTimeInput) ==  null) {
                  // If not, we just limit our hours due to the day
                  limitHoursToDay(endTimeInput, true)
                  return
                }
                
                data = getSelectData(dateInput)
                
                // If it was set, we set our lower bound to that value and our upper bound
                // to the end time depending on the day
                minHour = getSelectData(startTimeInput).hour
                maxHour = (data == null || data.day != 6) ? weekdayEndTime : saturdayEndTime
                
                // Set these values
                setNewTime(minHour, maxHour, true, endTimeInput)
              },
              
              interval: 60,
              formatSubmit: 'HH:i',
              hiddenSuffix: ''
            })
        });
        
        function setNewTime(min, max, increment, timeInput) {
          timePicker = getPicker(timeInput)
          
          // If we're dealing with our end time, the start time bound is 1 hour more
          // (can't end your shift at the very first hour)
          // Otherwise, our end time bound is hour less
          // (can't start your shift at the very last hour)
          min = increment ? min + 1 : min
          max = increment ? max : max - 1
          
          // Sets our bounds to the time forms
          timePicker.set('min', [min, 0])
          timePicker.set('max', [max, 0])
        }
        
        
        // Similar to checkInputBounds, this instead sets the bounds of the 
        // time inputs, and doesn't care about the values
        // Increment is a boolean not used in this function, but will be passed simply
        // to see if this is our end time form, if so, we need to do some math with it...
        function limitHoursToDay(input, increment) {
          // If no calandar day was set, we default to normal week day hours
          data = getSelectData(dateInput)
          if (data == null) {
            setNewTime(weekdayStartTime, weekdayEndTime, increment, input)
            return
          }
          
          // We set new bounds depending on the day...
          switch (data.day) {
            case 0:
              setNewTime(sundayStartTime, weekdayEndTime, increment, input)
              break
            case 6:
              setNewTime(saturdayStartTime, saturdayEndTime, increment, input)
              break
            default:
              setNewTime(weekdayStartTime, weekdayEndTime, increment, input)
          }
        }
        
        // Checks to see if the input time value is valid
        // a boolean is also passed (isEndTime), this is due to the fact that
        // the start time cannot be the very last hour, but our end time can
        function checkInputBounds(input, isEndTime) {
          data = getSelectData(dateInput)
          
          // If our data is null, meaning that the calandar value was not set
          // or if the time form we're checking doesnt have a value
          // or if it's not saturday or sunday, we simply return. 
          if (data == null || getSelectData(input) == null || (data.day != 0 && data.day != 6)) {
            return
          }
          
          // Otherwise, we set up some bounds to compare to depending on the day...
          min = (data.day == 0) ? sundayStartTime : saturdayStartTime
          max = (data.day == 0) ? weekdayEndTime : saturdayEndTime
          
          currentValue = getSelectData(input).hour
          
          // If the current time value is out of bounds, we clear it
          if (currentValue < min || (isEndTime ? currentValue > max : currentValue >= max)) {
            getPicker(input).clear()
          }
        }
        
        // Rather than constantly specifically choose which picker we're using and typing so much, 
        // this method does those checks for us and return a picker. Pickers can be considered as
        // the form handle
        function getPicker(input) {
          return (typeof input.pickadate('picker') == 'undefined') ? input.pickatime('picker') : input.pickadate('picker')
        }
        
        // This gets the data of a input, such as day and hours. This can be null
        function getSelectData(input) {
          return getPicker(input).get('select')
        }
    </script>
</head>

<body>
      <div id="menu">
        <ul>
            <li><a href="{% url 'index' %}" class='menu_link'> Hours </a></li>
            <li><a href="{% url 'AddHour' %}" class='menu_link'> Give </a></li>
            <li><a href="{% url 'history' %}" class='menu_link'> History </a></li>
            <li><a href="{% url 'comments' %}" class='menu_link'> Comments </a> </li>
            <li><a href="{% url 'main_page:index' %}" class='menu_link'> Home </a></li>
        </ul>
    </div>
    <form method="POST" action="">
        {% csrf_token %} 
        {{ form.as_p }}
        <input type="submit" value="Submit" onclick="checkTime();"/>
        {% if add %}
        <input type="submit" value="Delete" name="delete" id="delete" onclick="fillFields();"/>
        {% endif %}
    </form>
    
</body>

</html>
